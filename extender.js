function e(e,a){try{const t=bluemap?.mapViewer?.controlsManager?.data?.position,r=t?{x:Math.floor(t.x),y:Math.floor(t.y),z:Math.floor(t.z)}:null;window.parent.postMessage({type:e,...a,position:r},"*")}catch(a){console.error(`Error sending ${e}:`,a)}}function a(){const a=bluemap?.mapViewer?.data?.uniforms?.sunlightStrength?.value;void 0!==a&&e("onSunlightStrength",{value:a})}function t(){const a=function(){const e=a=>({id:a.id,label:a.label,listed:a.listed,visible:a.visible,toggleable:a.toggleable,markers:a.markers?a.markers.map(e=>({id:e.id,label:e.label,type:e.type,listed:e.listed,visible:e.visible,position:e.position?{x:e.position.x,y:e.position.y,z:e.position.z}:null,playerUuid:e.playerUuid,name:e.name,foreign:e.foreign})):[],markerSets:a.markerSets?a.markerSets.map(e):[]});return bluemap?.mapViewer?.data?.markerSets?bluemap.mapViewer.data.markerSets.map(e):[]}();e("markerListUpdate",{markers:JSON.stringify(a)})}let r=!1;function n(e,a,t){bluemap?.mapViewer?.controlsManager?.data?.position&&(bluemap.mapViewer.controlsManager.data.position.setX(parseFloat(e)),bluemap.mapViewer.controlsManager.data.position.setY(parseFloat(a)),bluemap.mapViewer.controlsManager.data.position.setZ(parseFloat(t)),bluemap.mapViewer.redraw())}let s="";function o(){if(!bluemap?.mapViewer?.controlsManager)return void setTimeout(o,1e3);let a=null;setInterval(()=>{if(r)return;const t=bluemap.appState.controls.state,n=bluemap?.mapViewer?.controlsManager?.data?.position;t!==s&&(e("onViewMode",{mode:t}),s=t),n&&(!a||Math.abs(n.x-a.x)>1||Math.abs(n.y-a.y)>1||Math.abs(n.z-a.z)>1)&&(e("onPosition",{}),a={...n})},300)}function i(s){const{data:o}=s;if(o)switch(o.type){case"viewMode":!function(e){const{command:a,options:t}=e;bluemap[a]&&(bluemap[a](t.transition,t.heightTransition),"setFreeFlight"===a?(bluemap.appState.controls.enableFreeFlight=!0,bluemap.appState.controls.showZoomButtons=!1):bluemap.appState.controls.enableFreeFlight=!1)}(o);break;case"animateSunlightStrength":!function(e){const t=bluemap?.mapViewer?.data?.uniforms?.sunlightStrength;if(!t)return void console.error("BlueMap or its properties are not available");r=!0;const n=t.value,s=performance.now();requestAnimationFrame(function o(i){const l=i-s,p=Math.min(l/300,1),u=p*(2-p);t.value=n*(1-u)+e*u,bluemap.mapViewer.redraw(),p<1?requestAnimationFrame(o):(a(),r=!1)})}(o.targetValue);break;case"updatePosition":n(o.x,o.y,o.z);break;case"switchMap":bluemap.switchMap&&bluemap.switchMap(o.mapId);break;case"resetView":bluemap.resetCamera&&bluemap.resetCamera();break;case"followPlayer":!function(e){if(e.follow){const a=bluemap.playerMarkerManager.getPlayerMarker(e.playerId);bluemap.mapViewer.controlsManager.controls.followPlayerMarker(a)}else bluemap.mapViewer.controlsManager.controls.stopFollowingPlayerMarker()}(o);break;case"updateSettings":!function(e){const{setting:a,value:t}=e;switch(a){case"hiresDistance":bluemap.mapViewer.data.loadedHiresViewDistance=t,bluemap.saveUserSetting("hiresViewDistance",t),bluemap.mapViewer.updateLoadedMapArea();break;case"lowresDistance":bluemap.mapViewer.data.loadedLowresViewDistance=t,bluemap.mapViewer.updateLoadedMapArea(),bluemap.saveUserSetting("lowresViewDistance",t);break;case"fov":bluemap.mapViewer.camera.fov=t;break;case"sunlightStrength":bluemap.mapViewer.data.uniforms.sunlightStrength.value=t,bluemap.mapViewer.redraw();break;case"ambientLight":bluemap.mapViewer.data.uniforms.ambientLight.value=t,bluemap.mapViewer.redraw();break;case"pauseTileLoading":bluemap.appState.controls.pauseTileLoading=t,bluemap.saveUserSetting("pauseTileLoading",t);break;case"invertMouse":bluemap.appState.controls.invertMouse=t,bluemap.updateControlsSettings(),bluemap.saveUserSetting("invertMouse",t);break;case"mouseSensitivity":bluemap.appState.controls.mouseSensitivity=t,bluemap.updateControlsSettings(),bluemap.saveUserSetting("mouseSensitivity",t);break;case"showChunkBorders":bluemap.setChunkBorders(t),bluemap.saveUserSetting("showChunkBorders",t),bluemap.mapViewer.redraw();break;case"showDebug":bluemap.setDebug(t),bluemap.saveUserSetting("showDebug",t);break;case"disableOriginalControl":l("true"===t);break;case"superSampling":bluemap.mapViewer.superSampling=t,bluemap.saveUserSetting("superSampling",t);break;case"resetSettings":bluemap.resetSettings()}}(o);break;case"teleportToPlayer":!function(e){const a=bluemap.playerMarkerManager.getPlayerMarker(e.playerId);if(a){const e=a.position,t=bluemap.mapViewer.controlsManager.data.position,r=10;(Math.abs(t.x-e.x)>r||Math.abs(t.z-e.z)>r)&&function(e,a,t,r,s,o){const i=performance.now();requestAnimationFrame(function l(p){const u=p-i,m=Math.min(u/1e3,1),c=1-Math.pow(1-m,3);n(e+(r-e)*c,a+(s-a)*c,t+(o-t)*c),m<1&&requestAnimationFrame(l)})}(t.x,t.y,t.z,e.x,e.y,e.z)}}(o);break;case"getMarkers":t();break;case"toggleMarkerSet":{const e=bluemap?.mapViewer?.markers,a=e?function e(a,t){if(a.data&&a.data.id===t)return a;if(a.markerSets&&a.markerSets.size)for(const r of a.markerSets.values()){const a=e(r,t);if(a)return a}return null}(e,o.markerSetId):null;a&&a.data.toggleable&&(a.visible=!a.visible,"function"==typeof a.data.saveState&&a.data.saveState()),t();break}case"getPlayerList":!function(){const a=bluemap?.mapViewer?.markers?.markerSets?.get("bm-players");let t=[];a&&(t=Array.from(a.markers.values()).map(e=>({uuid:e.data.playerUuid,name:e.data.name,position:e.position,rotation:e.data.rotation,foreign:e.data.foreign}))),e("playerListUpdate",{players:JSON.stringify(t)})}();break;case"takeScreenshot":!function(){try{const a=bluemap?.mapViewer?.renderer?.domElement;if(!a)throw new Error("Renderer canvas not found");e("screenshot",{dataUrl:a.toDataURL("image/png")})}catch(a){console.error("Error taking screenshot:",a),e("screenshot",{error:a.message})}}();break;case"updateMap":bluemap.updateMap&&bluemap.updateMap();break;case"updateTheme":bluemap.setTheme&&o.theme&&bluemap.setTheme(o.theme)}}function l(e){document.querySelectorAll(".control-bar").forEach(a=>{a.style.display=e?"none":"flex"})}let p="[BlueMap/E&E]";console.log(`${p} Initialization started`),console.log(`${p} Initializing BlueMapExternalExtender functionality`),bluemap.appState.controls.showZoomButtons=!1,o(),function(){let a=null;setInterval(()=>{const t=null!==bluemap?.mapViewer?.controlsManager?.data?.controls?.followingPlayer;t!==a&&(e("onFollowingPlayerStatus",{isFollowing:t}),a=t)},300)}(),function(){let a=null;setInterval(()=>{const t=bluemap.playerMarkerManager.fileUrl.split("/")[1];t!==a&&(e("onMapChange",{mapId:t}),a=t)},300)}(),window.addEventListener("message",i),a(),function(){const a={};for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(t.startsWith("bluemap-"))try{a[t]=JSON.parse(localStorage.getItem(t))}catch(e){a[t]=localStorage.getItem(t)}}e("localStorageData",{storage:JSON.stringify(a)})}(),function(){if(bluemap&&bluemap.appState&&bluemap.appState.maps){const a=bluemap.appState.maps.map(e=>({id:e.id,sorting:e.sorting})).sort((e,a)=>e.sorting-a.sorting);e("mapListUpdate",{maps:JSON.stringify(a)})}}(),function(){const a={hiresSliderMin:bluemap.settings.hiresSliderMin,hiresSliderMax:bluemap.settings.hiresSliderMax,hiresSliderDefault:bluemap.settings.hiresSliderDefault,lowresSliderMin:bluemap.settings.lowresSliderMin,lowresSliderMax:bluemap.settings.lowresSliderMax,lowresSliderDefault:bluemap.settings.lowresSliderDefault,resolutionDefault:bluemap.settings.resolutionDefault,version:bluemap.settings.version,maxZoomDistance:bluemap.settings.maxZoomDistance,minZoomDistance:bluemap.settings.minZoomDistance};e("allSettings",{settings:JSON.stringify(a)})}(),l(!0),function(){const a=bluemap.updatePageAddress;bluemap.updatePageAddress=function(...t){const r=a.apply(this,t);return e("onUrlChange",{url:window.location.href}),r},console.log(`${p} updatePageAddress function overridden`)}(),console.log(`${p} BlueMapExternalExtender functionality initialized`);